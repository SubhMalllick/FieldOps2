<script>
    // Enhanced Modal Functions with Debugging
    function openClientModal() {
        console.log('Opening client modal...');
        const modal = document.getElementById('clientModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        } else {
            console.error('Client modal not found!');
        }
    }

    function closeClientModal() {
        const modal = document.getElementById('clientModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }
    }

    function openAgentModal() {
        console.log('Opening agent modal...');
        const modal = document.getElementById('agentModal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            document.body.style.overflow = 'hidden';
        } else {
            console.error('Agent modal not found!');
        }
    }

    function closeAgentModal() {
        const modal = document.getElementById('agentModal');
        if (modal) {
            modal.classList.add('hidden');
            modal.classList.remove('flex');
            document.body.style.overflow = 'auto';
        }
    }

    // Form submission handlers
    async function submitClientForm(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/api/submit-client', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccessMessage(result.message);
                setTimeout(() => {
                    closeClientModal();
                    form.reset();
                }, 2000);
            } else {
                showErrorMessage(result.message || 'Something went wrong. Please try again.');
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            showErrorMessage('Network error. Please check your connection and try again.');
        } finally {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    async function submitAgentForm(event) {
        event.preventDefault();
        
        const form = event.target;
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        
        // Show loading state
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
        submitBtn.disabled = true;
        
        try {
            const response = await fetch('/api/submit-agent', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            });
            
            const result = await response.json();
            
            if (result.success) {
                showSuccessMessage(result.message);
                setTimeout(() => {
                    closeAgentModal();
                    form.reset();
                }, 2000);
            } else {
                showErrorMessage(result.message || 'Something went wrong. Please try again.');
            }
        } catch (error) {
            console.error('Error submitting form:', error);
            showErrorMessage('Network error. Please check your connection and try again.');
        } finally {
            // Reset button state
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
    }

    // Success message function
    function showSuccessMessage(message) {
        const successModal = document.createElement('div');
        successModal.className = 'fixed inset-0 bg-black/70 z-[60] flex items-center justify-center';
        successModal.innerHTML = `
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center animate-slide-in">
                <div class="w-16 h-16 bg-success rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-check text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-dark mb-2">Registration Successful!</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-primary text-white px-6 py-2 rounded-xl font-semibold hover:bg-secondary transition-colors">
                    Continue
                </button>
            </div>
        `;
        document.body.appendChild(successModal);
    }

    function showErrorMessage(message) {
        const errorModal = document.createElement('div');
        errorModal.className = 'fixed inset-0 bg-black/70 z-[60] flex items-center justify-center';
        errorModal.innerHTML = `
            <div class="bg-white rounded-2xl p-8 max-w-md mx-4 text-center animate-slide-in">
                <div class="w-16 h-16 bg-accent rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-exclamation-triangle text-white text-2xl"></i>
                </div>
                <h3 class="text-xl font-bold text-dark mb-2">Registration Failed</h3>
                <p class="text-gray-600 mb-6">${message}</p>
                <button onclick="this.closest('.fixed').remove()" class="bg-accent text-white px-6 py-2 rounded-xl font-semibold hover:bg-red-700 transition-colors">
                    Try Again
                </button>
            </div>
        `;
        document.body.appendChild(errorModal);
    }

    // Countdown functionality
    let spotsLeft = 47;
    let countdownInterval;

    function startCountdown() {
        clearInterval(countdownInterval);
        
        countdownInterval = setInterval(() => {
            const spotsCounter = document.getElementById('spotsCounter');
            
            if (spotsLeft > 1) {
                spotsLeft--;
            } else {
                spotsLeft = 47; // Reset to 47 when it reaches 1
            }
            
            // Update the counter with animation
            if (spotsCounter) {
                spotsCounter.textContent = spotsLeft;
                spotsCounter.classList.add('countdown-animation');
                
                // Remove animation class after animation completes
                setTimeout(() => {
                    spotsCounter.classList.remove('countdown-animation');
                }, 1000);
            }
            
            // Update urgency message when spots are low
            updateUrgencyMessage();
            
        }, 3000); // Change number every 3 seconds
    }

    function updateUrgencyMessage() {
        const urgencyBadge = document.querySelector('.urgent-badge');
        if (urgencyBadge && spotsLeft <= 10) {
            urgencyBadge.innerHTML = `
                <i class="fas fa-exclamation-triangle text-accent"></i>
                <span class="text-sm font-semibold">Only ${spotsLeft} spots left - Register Now!</span>
            `;
        }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Page loaded - initializing modals...');
        
        // Start the countdown
        startCountdown();
        
        // Close modals when clicking outside
        document.getElementById('clientModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeClientModal();
        });

        document.getElementById('agentModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeAgentModal();
        });

        // Close with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeClientModal();
                closeAgentModal();
            }
        });

        // Add backup event listeners for all agent buttons
        const agentButtons = document.querySelectorAll('button');
        agentButtons.forEach(button => {
            const buttonText = button.textContent?.toLowerCase() || '';
            if (buttonText.includes('field executive') || 
                buttonText.includes('become field') ||
                buttonText.includes('join as executive')) {
                button.addEventListener('click', openAgentModal);
                console.log('Added backup listener to:', button.textContent);
            }
            
            // Backup for client buttons
            if (buttonText.includes('business') || 
                buttonText.includes('register your')) {
                button.addEventListener('click', openClientModal);
            }
        });

        console.log('Found agent modals:', {
            client: document.getElementById('clientModal'),
            agent: document.getElementById('agentModal')
        });
    });

    // Enhanced scroll animation
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    // Observe elements for animation
    document.querySelectorAll('.stagger-animation > *').forEach(el => {
        observer.observe(el);
    });

    // Enhanced navbar background on scroll
    window.addEventListener('scroll', () => {
        const nav = document.querySelector('nav');
        if (window.scrollY > 100) {
            nav.classList.add('bg-white', 'shadow-lg', 'backdrop-blur-md');
            nav.classList.remove('bg-white/80');
        } else {
            nav.classList.remove('bg-white', 'shadow-lg');
            nav.classList.add('bg-white/80');
        }
    });

    // Add smooth scrolling for navigation links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });

    // Add loading animation
    window.addEventListener('load', function() {
        document.body.classList.add('loaded');
    });
</script>
